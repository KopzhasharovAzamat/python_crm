<!--templates/products.html-->
{% extends 'base.html' %}
{% load i18n %}

{% block content %}
<h2 class="mb-4 animate__animated animate__fadeIn">Товары</h2>
<div class="mb-4">
    <a href="{% url 'product_add' %}" class="btn btn-success"><i class="fas fa-plus"></i> Добавить товар</a>
    <a href="{% url 'cart_create' %}" class="btn btn-primary"><i class="fas fa-shopping-cart"></i> Новая корзина</a>
    <a href="{% url 'archived_products' %}" class="btn btn-secondary"><i class="fas fa-archive"></i> Архивированные товары</a>
</div>

<!-- Форма фильтров и сортировки -->
<form method="get" class="mb-4" id="filter-form">
    <div class="row g-3">
        <div class="col-md-3">
            <input type="text" name="q" id="search-input" placeholder="Поиск..." value="{{ request.GET.q }}" class="form-control">
        </div>
        <div class="col-md-2">
            <select name="category" class="form-control">
                <option value="">Все категории</option>
                {% for cat in categories %}
                <option value="{{ cat.name }}" {% if request.GET.category == cat.name %}selected{% endif %}>{{ cat.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <select name="subcategory" class="form-control">
                <option value="">Все подкатегории</option>
                {% for subcat in subcategories %}
                <option value="{{ subcat.name }}" {% if request.GET.subcategory == subcat.name %}selected{% endif %}>{{ subcat.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <select name="warehouse" class="form-control">
                <option value="">Все склады</option>
                {% for wh in warehouses %}
                <option value="{{ wh.name }}" {% if request.GET.warehouse == wh.name %}selected{% endif %}>{{ wh.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <input type="number" name="min_quantity" placeholder="Мин. остаток" value="{{ request.GET.min_quantity }}" class="form-control">
        </div>
        <div class="col-md-2">
            <select name="sort_by" class="form-control">
                <option value="">Сортировать...</option>
                <option value="name" {% if request.GET.sort_by == 'name' %}selected{% endif %}>По названию (А-Я)</option>
                <option value="-name" {% if request.GET.sort_by == '-name' %}selected{% endif %}>По названию (Я-А)</option>
                <option value="category__name" {% if request.GET.sort_by == 'category__name' %}selected{% endif %}>По категории (А-Я)</option>
                <option value="-category__name" {% if request.GET.sort_by == '-category__name' %}selected{% endif %}>По категории (Я-А)</option>
                <option value="subcategory__name" {% if request.GET.sort_by == 'subcategory__name' %}selected{% endif %}>По подкатегории (А-Я)</option>
                <option value="-subcategory__name" {% if request.GET.sort_by == '-subcategory__name' %}selected{% endif %}>По подкатегории (Я-А)</option>
                <option value="selling_price" {% if request.GET.sort_by == 'selling_price' %}selected{% endif %}>По цене (возр.)</option>
                <option value="-selling_price" {% if request.GET.sort_by == '-selling_price' %}selected{% endif %}>По цене (убыв.)</option>
                <option value="quantity" {% if request.GET.sort_by == 'quantity' %}selected{% endif %}>По количеству (возр.)</option>
                <option value="-quantity" {% if request.GET.sort_by == '-quantity' %}selected{% endif %}>По количеству (убыв.)</option>
                <option value="warehouse__name" {% if request.GET.sort_by == 'warehouse__name' %}selected{% endif %}>По складу (А-Я)</option>
                <option value="-warehouse__name" {% if request.GET.sort_by == '-warehouse__name' %}selected{% endif %}>По складу (Я-А)</option>
            </select>
        </div>
        <div class="col-md-1 d-flex gap-2">
            <button type="submit" class="btn btn-primary flex-fill"><i class="fas fa-filter"></i> Фильтр</button>
            <a href="{% url 'products' %}" class="btn btn-secondary flex-fill"><i class="fas fa-times"></i> Очистить</a>
        </div>
    </div>
</form>

{% if low_stock_message %}
<div class="alert alert-warning alert-dismissible fade show animate__animated animate__fadeIn" role="alert">
    {{ low_stock_message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<div class="row row-cols-1 row-cols-md-3 g-4">
    {% for product in products %}
    <div class="col">
        <div class="card h-100 {% if product.quantity < 5 %}border-danger{% endif %} animate__animated animate__fadeInUp">
            {% if product.photo %}
            <img src="{{ product.photo.url }}" class="card-img-top" alt="{{ product.name }}" style="max-width: 100%;">
            {% else %}
            <div class="card-img-top bg-secondary d-flex align-items-center justify-content-center" style="height: 200px;">
                <i class="fas fa-image fa-3x text-white"></i>
            </div>
            {% endif %}
            <div class="card-body">
                <h5 class="card-title"><a href="{% url 'product_detail' product.id %}" class="text-decoration-none">{{ product.name }}</a></h5>
                <p class="card-text">
                    <strong>Категория:</strong> {{ product.category|default:"Не указана" }}<br>
                    <strong>Подкатегория:</strong> {{ product.subcategory|default:"Не указана" }}<br>
                    <strong>Склад:</strong> {{ product.warehouse.name }}<br>
                    <strong>Количество:</strong> {{ product.quantity }}<br>
                    {% if product.quantity < 5 %}
                    <span class="text-danger"><strong>Осталось мало товара!</strong></span><br>
                    {% endif %}
                    <strong>Цена:</strong> {{ product.selling_price }} ₽
                </p>
            </div>
            <div class="card-footer d-flex gap-2 justify-content-center flex-wrap">
                <a href="{% url 'cart_create' %}" class="btn btn-primary shadow-sm" style="font-size: 0.9rem; padding: 0.4rem 0.8rem;"><i class="fas fa-shopping-cart me-1"></i> Продать</a>
                <a href="{% url 'product_edit' product.id %}" class="btn btn-warning shadow-sm" style="font-size: 0.9rem; padding: 0.4rem 0.8rem;"><i class="fas fa-edit me-1"></i> Редактировать</a>
                <button class="btn btn-secondary shadow-sm delete-btn" data-action="{% url 'product_archive' product.id %}" data-message="Вы уверены, что хотите архивировать товар {{ product.name }}?" style="font-size: 0.9rem; padding: 0.4rem 0.8rem;"><i class="fas fa-archive me-1"></i> Архивировать</button>
                <button class="btn btn-danger shadow-sm delete-btn" data-action="{% url 'product_delete' product.id %}" data-message="Вы уверены, что хотите удалить товар {{ product.name }}?" style="font-size: 0.9rem; padding: 0.4rem 0.8rem;"><i class="fas fa-trash me-1"></i> Удалить</button>
            </div>
        </div>
    </div>
    {% empty %}
    <p>Нет товаров для отображения.</p>
    {% endfor %}
</div>

<!-- Модальное окно для ошибок -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #A3BFFA, #FBB6CE);">
                <h5 class="modal-title text-white" id="errorModalLabel">Ошибка</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="errorMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<!-- Убираем модальное окно успеха, так как перенаправление будет автоматическим -->

<!-- JavaScript для обработки вставки UUID -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
    const errorMessage = document.getElementById('errorMessage');
    const csrfToken = getCsrfToken(); // Используем функцию из base.html

    document.addEventListener('paste', async function(e) {
        const pastedText = (e.clipboardData || window.clipboardData).getData('text').trim();
        const uuidPattern = /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/;
        if (!uuidPattern.test(pastedText)) {
            return;
        }

        e.preventDefault();

        try {
            // 1. Создаём новую корзину через AJAX
            const createCartResponse = await fetch('{% url "cart_create" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest', // Явно указываем, что это AJAX-запрос
                },
                credentials: 'include',
            });

            if (createCartResponse.status === 403 || createCartResponse.status === 401) {
                errorMessage.textContent = 'Пожалуйста, войдите в систему.';
                errorModal.show();
                setTimeout(() => {
                    window.location.href = '{% url "login" %}';
                }, 2000);
                return;
            }

            if (!createCartResponse.ok) {
                const errorData = await createCartResponse.json();
                throw new Error(errorData.error || 'Не удалось создать корзину.');
            }

            const cartData = await createCartResponse.json();
            if (!cartData.cart_id) {
                throw new Error('Не удалось получить ID корзины.');
            }

            const cartId = cartData.cart_id;

            // 2. Получаем информацию о товаре по UUID
            const productResponse = await fetch(`/get-product-by-uuid/?unique_id=${pastedText}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'include',
            });

            if (!productResponse.ok) {
                const errorData = await productResponse.json();
                throw new Error(errorData.error || 'Не удалось получить товар.');
            }

            const productData = await productResponse.json();
            if (productData.error) {
                errorMessage.textContent = productData.error || 'Товар не найден.';
                errorModal.show();
                return;
            }

            // 3. Добавляем товар в корзину через AJAX
            const addItemResponse = await fetch(`/cart/${cartId}/add_item/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest', // Явно указываем, что это AJAX-запрос
                },
                credentials: 'include',
                body: JSON.stringify({
                    product: productData.id,
                    quantity: 1,
                    actual_price: productData.selling_price,
                }),
            });

            if (addItemResponse.status === 403 || addItemResponse.status === 401) {
                errorMessage.textContent = 'Пожалуйста, войдите в систему.';
                errorModal.show();
                setTimeout(() => {
                    window.location.href = '{% url "login" %}';
                }, 2000);
                return;
            }

            if (!addItemResponse.ok) {
                const errorData = await addItemResponse.json();
                throw new Error(errorData.error || 'Не удалось добавить товар в корзину.');
            }

            const addItemData = await addItemResponse.json();
            if (addItemData.error) {
                errorMessage.textContent = addItemData.error || 'Не удалось добавить товар в корзину.';
                errorModal.show();
                return;
            }

            if (!addItemData.success) {
                throw new Error('Не удалось подтвердить добавление товара.');
            }

            // 4. Перенаправляем пользователя на страницу редактирования корзины
            window.location.href = `/cart/${cartId}/add_item/`;
        } catch (error) {
            console.error('Ошибка:', error);
            errorMessage.textContent = error.message || 'Произошла ошибка при обработке запроса.';
            errorModal.show();
        }
    });
});
</script>
{% endblock %}